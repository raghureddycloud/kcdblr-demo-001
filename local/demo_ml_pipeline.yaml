# PIPELINE DEFINITION
# Name: demo-ml-pipeline
# Description: Simple ML pipeline demonstrating Kubeflow benefits with KServe deployment
# Inputs:
#    accuracy_threshold: float [Default: 0.7]
#    model_name: str [Default: 'demo-classifier']
#    namespace: str [Default: 'default']
components:
  comp-deploy-model-kserve:
    executorLabel: exec-deploy-model-kserve
    inputDefinitions:
      artifacts:
        model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
      parameters:
        model_name:
          parameterType: STRING
        namespace:
          defaultValue: default
          isOptional: true
          parameterType: STRING
    outputDefinitions:
      parameters:
        Output:
          parameterType: STRING
  comp-generate-data:
    executorLabel: exec-generate-data
    outputDefinitions:
      artifacts:
        dataset:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
  comp-train-model:
    executorLabel: exec-train-model
    inputDefinitions:
      artifacts:
        dataset:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
    outputDefinitions:
      artifacts:
        model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
      parameters:
        accuracy:
          parameterType: NUMBER_DOUBLE
        model_name:
          parameterType: STRING
  comp-validate-model:
    executorLabel: exec-validate-model
    inputDefinitions:
      artifacts:
        dataset:
          artifactType:
            schemaTitle: system.Dataset
            schemaVersion: 0.0.1
        model:
          artifactType:
            schemaTitle: system.Model
            schemaVersion: 0.0.1
      parameters:
        accuracy_threshold:
          defaultValue: 0.7
          isOptional: true
          parameterType: NUMBER_DOUBLE
    outputDefinitions:
      parameters:
        Output:
          parameterType: STRING
deploymentSpec:
  executors:
    exec-deploy-model-kserve:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - deploy_model_kserve
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"'  &&\
          \  python3 -m pip install --quiet --no-warn-script-location 'kubernetes'\
          \ 'pyyaml' && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef deploy_model_kserve(\n    model: Input[Model],\n    model_name:\
          \ str,\n    namespace: str = \"default\"\n) -> str:\n    \"\"\"Deploy model\
          \ using KServe\"\"\"\n    import yaml\n    import os\n\n    # Create KServe\
          \ InferenceService YAML\n    inference_service = {\n        \"apiVersion\"\
          : \"serving.kserve.io/v1beta1\",\n        \"kind\": \"InferenceService\"\
          ,\n        \"metadata\": {\n            \"name\": model_name,\n        \
          \    \"namespace\": namespace\n        },\n        \"spec\": {\n       \
          \     \"predictor\": {\n                \"sklearn\": {\n               \
          \     \"storageUri\": f\"pvc://models/{model_name}\",\n                \
          \    \"resources\": {\n                        \"limits\": {\n         \
          \                   \"cpu\": \"100m\",\n                            \"memory\"\
          : \"256Mi\"\n                        },\n                        \"requests\"\
          : {\n                            \"cpu\": \"50m\",\n                   \
          \         \"memory\": \"128Mi\"\n                        }\n           \
          \         }\n                }\n            }\n        }\n    }\n\n    #\
          \ Save the YAML file\n    yaml_path = \"/tmp/inference_service.yaml\"\n\
          \    with open(yaml_path, 'w') as f:\n        yaml.dump(inference_service,\
          \ f, default_flow_style=False)\n\n    print(f\"Created KServe InferenceService\
          \ YAML:\")\n    print(yaml.dump(inference_service, default_flow_style=False))\n\
          \n    # In a real scenario, you would apply this YAML to the cluster\n \
          \   # kubectl apply -f /tmp/inference_service.yaml\n\n    deployment_info\
          \ = f\"\"\"\nDeployment Configuration Created:\n- Model Name: {model_name}\n\
          - Namespace: {namespace}\n- Framework: SKLearn\n- Resources: 50-100m CPU,\
          \ 128-256Mi Memory\n\nTo deploy manually, run:\nkubectl apply -f {yaml_path}\n\
          \nOr use the KServe Python SDK in your cluster.\n\"\"\"\n\n    return deployment_info\n\
          \n"
        image: python:3.9
    exec-generate-data:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - generate_data
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"'  &&\
          \  python3 -m pip install --quiet --no-warn-script-location 'pandas' 'scikit-learn'\
          \ 'numpy' && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef generate_data(dataset: Output[Dataset]):\n    \"\"\"Generate\
          \ sample data for training\"\"\"\n    import pandas as pd\n    from sklearn.datasets\
          \ import make_classification\n    import numpy as np\n\n    # Generate synthetic\
          \ classification data\n    X, y = make_classification(\n        n_samples=1000,\n\
          \        n_features=4,\n        n_informative=2,\n        n_redundant=0,\n\
          \        random_state=42,\n        shuffle=False\n    )\n\n    # Create\
          \ DataFrame\n    df = pd.DataFrame(X, columns=[f'feature_{i}' for i in range(4)])\n\
          \    df['target'] = y\n\n    # Save dataset\n    df.to_csv(dataset.path,\
          \ index=False)\n    print(f\"Generated dataset with {len(df)} samples\"\
          )\n    print(f\"Features: {df.columns.tolist()}\")\n\n"
        image: python:3.9
    exec-train-model:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - train_model
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"'  &&\
          \  python3 -m pip install --quiet --no-warn-script-location 'pandas' 'scikit-learn'\
          \ 'joblib' 'numpy' && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef train_model(\n    dataset: Input[Dataset],\n    model: Output[Model]\n\
          ) -> NamedTuple('Outputs', [('accuracy', float), ('model_name', str)]):\n\
          \    \"\"\"Train a simple classification model\"\"\"\n    import pandas\
          \ as pd\n    from sklearn.ensemble import RandomForestClassifier\n    from\
          \ sklearn.model_selection import train_test_split\n    from sklearn.metrics\
          \ import accuracy_score\n    import joblib\n    import os\n\n    # Load\
          \ data\n    df = pd.read_csv(dataset.path)\n    X = df.drop('target', axis=1)\n\
          \    y = df['target']\n\n    # Split data\n    X_train, X_test, y_train,\
          \ y_test = train_test_split(\n        X, y, test_size=0.2, random_state=42\n\
          \    )\n\n    # Train model\n    clf = RandomForestClassifier(n_estimators=10,\
          \ random_state=42)\n    clf.fit(X_train, y_train)\n\n    # Evaluate\n  \
          \  y_pred = clf.predict(X_test)\n    accuracy = accuracy_score(y_test, y_pred)\n\
          \n    # Save model\n    model_path = os.path.join(model.path, \"model.joblib\"\
          )\n    os.makedirs(model.path, exist_ok=True)\n    joblib.dump(clf, model_path)\n\
          \n    print(f\"Model trained with accuracy: {accuracy:.4f}\")\n\n    from\
          \ collections import namedtuple\n    Outputs = namedtuple('Outputs', ['accuracy',\
          \ 'model_name'])\n    return Outputs(accuracy, \"demo-classifier\")\n\n"
        image: python:3.9
    exec-validate-model:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - validate_model
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"'  &&\
          \  python3 -m pip install --quiet --no-warn-script-location 'pandas' 'scikit-learn'\
          \ 'joblib' && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef validate_model(\n    dataset: Input[Dataset],\n    model: Input[Model],\n\
          \    accuracy_threshold: float = 0.7\n) -> str:\n    \"\"\"Validate model\
          \ performance\"\"\"\n    import pandas as pd\n    from sklearn.model_selection\
          \ import train_test_split\n    from sklearn.metrics import accuracy_score,\
          \ classification_report\n    import joblib\n    import os\n\n    # Load\
          \ data and model\n    df = pd.read_csv(dataset.path)\n    X = df.drop('target',\
          \ axis=1)\n    y = df['target']\n\n    model_path = os.path.join(model.path,\
          \ \"model.joblib\")\n    clf = joblib.load(model_path)\n\n    # Use test\
          \ split for validation\n    _, X_test, _, y_test = train_test_split(\n \
          \       X, y, test_size=0.2, random_state=42\n    )\n\n    # Predict and\
          \ evaluate\n    y_pred = clf.predict(X_test)\n    accuracy = accuracy_score(y_test,\
          \ y_pred)\n\n    print(f\"Validation accuracy: {accuracy:.4f}\")\n    print(\"\
          \\nClassification Report:\")\n    print(classification_report(y_test, y_pred))\n\
          \n    if accuracy >= accuracy_threshold:\n        result = \"PASSED\"\n\
          \        print(f\"\u2705 Model validation PASSED (accuracy {accuracy:.4f}\
          \ >= {accuracy_threshold})\")\n    else:\n        result = \"FAILED\"\n\
          \        print(f\"\u274C Model validation FAILED (accuracy {accuracy:.4f}\
          \ < {accuracy_threshold})\")\n\n    return result\n\n"
        image: python:3.9
pipelineInfo:
  description: Simple ML pipeline demonstrating Kubeflow benefits with KServe deployment
  name: demo-ml-pipeline
root:
  dag:
    tasks:
      deploy-model-kserve:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-deploy-model-kserve
        dependentTasks:
        - train-model
        - validate-model
        inputs:
          artifacts:
            model:
              taskOutputArtifact:
                outputArtifactKey: model
                producerTask: train-model
          parameters:
            model_name:
              componentInputParameter: model_name
            namespace:
              componentInputParameter: namespace
        taskInfo:
          name: KServe Deployment
      generate-data:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-generate-data
        taskInfo:
          name: Data Generation
      train-model:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-train-model
        dependentTasks:
        - generate-data
        inputs:
          artifacts:
            dataset:
              taskOutputArtifact:
                outputArtifactKey: dataset
                producerTask: generate-data
        taskInfo:
          name: Model Training
      validate-model:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-validate-model
        dependentTasks:
        - generate-data
        - train-model
        inputs:
          artifacts:
            dataset:
              taskOutputArtifact:
                outputArtifactKey: dataset
                producerTask: generate-data
            model:
              taskOutputArtifact:
                outputArtifactKey: model
                producerTask: train-model
          parameters:
            accuracy_threshold:
              componentInputParameter: accuracy_threshold
        taskInfo:
          name: Model Validation
  inputDefinitions:
    parameters:
      accuracy_threshold:
        defaultValue: 0.7
        isOptional: true
        parameterType: NUMBER_DOUBLE
      model_name:
        defaultValue: demo-classifier
        isOptional: true
        parameterType: STRING
      namespace:
        defaultValue: default
        isOptional: true
        parameterType: STRING
schemaVersion: 2.1.0
sdkVersion: kfp-2.5.0
